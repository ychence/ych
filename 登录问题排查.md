# 登录失败排查指南

## 问题描述
登录时返回错误：`{detail: "Failed to login"}`

## 排查步骤

### 1. 运行 Azure 连接测试

首先测试 Azure 服务连接是否正常：

```bash
cd /Users/zhangjunjie/code_dowload/学生作业云服务器/1/设计/bancked
python test_connection.py
```

这个脚本会检查：
- ✓ 配置文件是否正确加载
- ✓ Cosmos DB 连接是否正常
- ✓ Blob Storage 连接是否正常
- ✓ 用户查询功能是否正常

### 2. 运行认证功能测试

测试注册和登录功能：

```bash
python test_auth.py
```

这个脚本会：
- 创建测试用户
- 测试登录功能
- 测试密码验证

### 3. 查看后端日志

现在改进的代码会输出详细的错误信息。启动后端服务：

```bash
python app.py
```

然后尝试登录，查看终端输出的详细日志，包括：
- `Login attempt for email: xxx` - 登录尝试
- `Login failed: User not found` - 用户不存在
- `Login failed: Invalid password` - 密码错误
- `Login error: xxx` - 具体错误信息（带完整堆栈）

### 4. 常见问题和解决方案

#### 问题 1: Azure Cosmos DB 连接失败

**症状**:
```
Failed to login: xxx
Cosmos DB 连接失败
```

**解决方案**:
1. 检查 `.env` 文件中的 `COSMOS_ENDPOINT` 和 `COSMOS_KEY`
2. 确认 Azure Cosmos DB 服务正在运行
3. 检查网络连接（防火墙、VPN 等）
4. 在 Azure Portal 检查 Cosmos DB 的防火墙设置，确保允许你的 IP

#### 问题 2: 用户不存在

**症状**:
```
Login failed: User not found for email xxx
```

**解决方案**:
1. 先注册用户再登录
2. 检查邮箱是否拼写正确
3. 在 Azure Portal 的 Cosmos DB Data Explorer 中查看 users 容器是否有数据

#### 问题 3: 密码错误

**症状**:
```
Login failed: Invalid password for email xxx
```

**解决方案**:
1. 确认密码是否正确
2. 检查前端是否正确发送密码
3. 使用测试脚本测试

#### 问题 4: CORS 错误

**症状**:
浏览器控制台显示 CORS 错误

**解决方案**:
1. 现在前端已集成到后端，不应该有 CORS 问题
2. 确保访问 `http://localhost:8000/` 而不是 `http://localhost:4200/`
3. 检查 `.env` 中的 `ALLOWED_ORIGINS` 配置（如果需要分离部署）

#### 问题 5: JWT 配置问题

**症状**:
```
Failed to login: JWT related error
```

**解决方案**:
检查 `.env` 文件中的 `JWT_SECRET_KEY` 是否配置

### 5. 前端调试

在浏览器开发者工具中：

1. **Network 标签页**：
   - 查看登录请求的 URL 是否正确（应该是 `/api/auth/login`）
   - 查看请求 Payload 是否包含正确的 email 和 password
   - 查看响应状态码和响应体

2. **Console 标签页**：
   - 查看是否有 JavaScript 错误
   - 查看是否有 CORS 错误

### 6. 手动测试 API

使用 curl 测试登录接口：

```bash
# 先注册用户
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "Test User",
    "email": "test@example.com",
    "password": "Test123456!"
  }'

# 然后登录
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123456!"
  }'
```

### 7. 检查环境变量

确保 `.env` 文件包含所有必需的配置：

```bash
# 查看配置（不显示敏感信息）
cat .env | grep -v KEY | grep -v SECRET
```

必需的配置项：
- COSMOS_ENDPOINT
- COSMOS_KEY
- COSMOS_DATABASE_NAME
- AZURE_STORAGE_CONNECTION_STRING
- JWT_SECRET_KEY

## 改进内容

现在的代码已经改进：

1. ✅ **详细的错误日志**：登录失败时会显示具体的错误信息
2. ✅ **错误堆栈追踪**：使用 `exc_info=True` 输出完整堆栈
3. ✅ **具体的错误信息**：`detail=f"Failed to login: {str(e)}"` 显示具体错误
4. ✅ **诊断脚本**：`test_connection.py` 和 `test_auth.py`
5. ✅ **前端集成**：无需处理 CORS 问题

## 下一步

1. 运行 `python test_connection.py` 确认 Azure 连接正常
2. 运行 `python test_auth.py` 测试认证功能
3. 启动后端 `python app.py`
4. 访问 `http://localhost:8000/` 测试前端
5. 查看后端终端的详细日志找出具体错误原因

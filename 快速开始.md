# 快速开始指南 (Quick Start Guide)

## 1. 安装依赖

### macOS/Linux:
```bash
# 进入backend目录
cd "/Users/zhangjunjie/code_dowload/学生作业云服务器/1/设计/bancked"

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### Windows:
```cmd
# 进入backend目录
cd "C:\...\学生作业云服务器\1\设计\bancked"

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

## 2. 配置Azure服务

### 2.1 创建Azure Cosmos DB

1. 登录Azure Portal (https://portal.azure.com)
2. 创建 Cosmos DB 账户:
   - 选择API: **Azure Cosmos DB for NoSQL**
   - 记录端点URL和主密钥
3. 数据库和容器会在首次运行时自动创建

### 2.2 创建Azure Blob Storage

1. 在Azure Portal创建存储账户
2. 记录连接字符串 (在"访问密钥"中)
3. 容器会在首次运行时自动创建

### 2.3 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件
nano .env  # 或使用其他编辑器
```

填写以下信息:
```env
# Azure Cosmos DB - 从Azure Portal获取
COSMOS_ENDPOINT=https://your-cosmosdb-account.documents.azure.com:443/
COSMOS_KEY=你的CosmosDB主密钥

# Azure Blob Storage - 从Azure Portal获取
AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;AccountName=...

# JWT密钥 - 生成一个随机字符串
JWT_SECRET_KEY=你的超级安全密钥请修改这个

# 前端地址
ALLOWED_ORIGINS=http://localhost:4200
```

## 3. 运行应用

### 方式1: 使用启动脚本 (推荐)

**macOS/Linux:**
```bash
./start.sh
```

**Windows:**
```cmd
start.bat
```

### 方式2: 直接运行

```bash
# 确保虚拟环境已激活
python main.py
```

### 方式3: 使用uvicorn

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

## 4. 访问API

启动成功后:
- **API地址**: http://localhost:8000/api
- **API文档**: http://localhost:8000/api/docs (Swagger UI)
- **健康检查**: http://localhost:8000/api/health

## 5. 测试API

### 5.1 注册用户
```bash
curl -X POST http://localhost:8000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123"
  }'
```

### 5.2 登录
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

返回的token复制下来,用于后续请求。

### 5.3 上传文件
```bash
curl -X POST http://localhost:8000/api/media \
  -H "Authorization: Bearer 你的JWT令牌" \
  -F "file=@/path/to/image.jpg" \
  -F "description=测试图片" \
  -F 'tags=["test", "demo"]'
```

### 5.4 获取媒体列表
```bash
curl -X GET "http://localhost:8000/api/media?page=1&pageSize=10" \
  -H "Authorization: Bearer 你的JWT令牌"
```

## 6. 配置前端

前端需要配置API地址。修改前端环境配置文件:

```typescript
// frontend/src/environments/environment.ts
export const environment = {
  production: false,
  apiUrl: 'http://localhost:8000/api'
};
```

## 7. 常见问题

### Q: 提示无法连接到Cosmos DB
**A**: 检查以下内容:
- `.env` 文件中的 `COSMOS_ENDPOINT` 和 `COSMOS_KEY` 是否正确
- 网络连接是否正常
- Azure Cosmos DB防火墙是否允许你的IP

### Q: 文件上传失败
**A**: 检查以下内容:
- Azure Storage连接字符串是否正确
- 存储账户防火墙设置
- 文件大小是否超过100MB

### Q: CORS错误
**A**: 确保 `.env` 中的 `ALLOWED_ORIGINS` 包含前端地址:
```env
ALLOWED_ORIGINS=http://localhost:4200
```

### Q: JWT token无效
**A**:
- 确保在请求头中正确设置: `Authorization: Bearer <token>`
- token可能已过期,重新登录获取新token
- `JWT_SECRET_KEY` 不要随意更改

## 8. 生产部署

部署到生产环境前:

1. **更改JWT密钥**: 生成强随机密钥
   ```bash
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   ```

2. **配置CORS**: 设置正确的前端域名

3. **启用HTTPS**: 使用反向代理(nginx)或Azure App Service

4. **监控日志**: 配置Azure Application Insights

5. **备份**: 启用Cosmos DB的时间点恢复

## 9. 项目结构

```
bancked/
├── main.py              # FastAPI主应用
├── config.py            # 配置管理
├── models.py            # 数据模型
├── auth.py              # 认证模块
├── database.py          # Cosmos DB集成
├── storage.py           # Blob Storage集成
├── utils.py             # 工具函数
├── routes_auth.py       # 认证路由
├── routes_media.py      # 媒体管理路由
├── requirements.txt     # 依赖列表
├── .env.example         # 环境变量模板
├── .env                 # 实际环境变量(不提交到git)
├── .gitignore          # Git忽略文件
├── start.sh            # Linux/Mac启动脚本
├── start.bat           # Windows启动脚本
└── README.md           # 详细文档
```

## 10. 下一步

- 查看完整API文档: http://localhost:8000/api/docs
- 阅读详细README: [README.md](README.md)
- 配置前端连接后端API
- 测试所有功能

---

**需要帮助?**
- 查看 README.md 获取详细文档
- 检查API文档了解所有端点
- 查看日志排查问题
